<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Countdown Timer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0 auto;
    }
    #timer {
      font-size: 48px;
    }
    .content-container {
      display: flex;
      border: 1px solid blue;
    }
    .content-section {
      border: 1px solid green;
      min-height: 100px;
    }
    #timer-container {
      width: 40%;
    }
    #todo-container {
      width: 60%;
    }
    .content-section > div {
      border: 1px solid black;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    #timer-select {
      margin-left: 5px;
    }
    .timer-controls {
      width: 100%;
      margin-top: 10px;
    }
    button {
      padding: 10px;
      width: 25%;
      margin: 5px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <h1>Pomodoro</h1>
  <div class="content-container">
    <!-- Timer section-->
    <div id="timer-container" class="content-section">
      <div id="timer">
        <select id="timer-select">
          <option value="5">5 Minutes</option>
          <option value="10">10 Minutes</option>
          <option value="custom">Custom</option>
        </select>
        <input
          type= "number"
          id= "custom-timer-input"
          placeholder= "Enter custom time (min)"
          style= "display: none; margin-top: 10px" 
          />
        <span id="timer-counter">5:00</span>
        <div class="timer-controls">
          <button id="start-btn" onclick="start_timer()">Start</button>
          <button id="pause-btn" onclick='pause_timer()'>Pause</button>
          <button id="reset-btn" onclick="reset_timer()">Reset</button>
        </div>
      </div>
      </div>

      <!--ToDo section-->
        <div id="todo-container" class="content-section">
            <div>
                <span>ToDo</span>
                <div class="todo-list">
                    <ul id="task-list">
                        <li>Task 1 | EST Time | Est Pomodoro</li>
                    </ul>
                    <div id="task-addition">
                        <!-- Here is where we will add tasks -->
                        <input type="text" name="task-name">
                        <input type="text" name="task-est-time" placeholder="Est. time (minutes)">
                        <button id="add-task-button">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    //TIMER FUNCTIONALITY
    function convert_seconds(seconds) {
      var minutes = Math.floor(seconds / 60);
      var remaining = seconds % 60;
      return minutes+":"+remaining.toString().padStart(2, '0');
    }

    document.addEventListener("DOMContentLoaded", function () {
      const timerDisplay = document.getElementById("timer-counter");
      const addTaskButton = document.getElementById("add-task-button");
      const taskList = document.getElementById("task-list");
      const timerSelect = document.getElementById("timer-select");
      const customTimerInput = document.getElementById("custom-timer-input");

    timerSelect.addEventListener("change", () => {
      if (timerSelect.value === "custom") {
        customTimerInput.style.display = "block";
      } else {
        customTimerInput.style.display = "none";
      }
});


  let ptimer = null;

  class Timer {
    constructor(seconds, display_dom) {
      this.seconds = seconds;
      this.state = "Stopped";
      this.current = this.seconds;
      this.starttime = null;
      this.elapsed = 0;
      this.timer_loop = null;
      this.sync_counter = 0;
      this.display_dom = display_dom;
    }

    startTimer() {
      if (this.state === "Running") return;

      if (this.state === "Paused"){
         this.starttime = new Date().getTime() - (this.elapsed * 1000);
      } else {
      this.starttime = new Date().getTime();
      this.elapsed = 0;
      this.current = this.seconds;
      }
      
      this.state = "Running"

      this.timer_loop = setInterval((timer) => {
        if (timer.sync_counter % 10 === 0) {
          timer.timerSync();
          timer.sync_counter = 0;
        } else {
          timer.countDown();
        }
        timer.sync_counter++;
      }, 1000, this);
    }

    stopTimer() {
      if (this.timer_loop) {
        clearInterval(this.timer_loop);
        this.timer_loop = null;
      }
      this.state = "Stopped"; 
    }

    pauseTimer() {
      if (this.timer_loop) {
        clearInterval(this.timer_loop);
        this.timer_loop = null;
        this.state = "Paused";
      }
    }

    resetTimer() {
      if (this.timer_loop) {
        clearInterval(this.timer_loop);
        this.timer_loop = null;
      }
      this.current = this.seconds;
      this.elapsed = 0;
      this.starttime = null;
      this.sync_counter = 0;
      this.state = "Stopped";
      this.display_dom.innerText = convert_seconds(this.current);
    }


    countDown() {
      this.current -= 1;
      this.display_dom.innerText = convert_seconds(this.current);
      this.finished();
    }

    timerSync() {
      const elapsed = new Date().getTime() - this.starttime;
      this.elapsed = Math.floor(elapsed / 1000);
      this.current = this.seconds - this.elapsed;
      this.display_dom.innerText = convert_seconds(this.current);
      this.finished();
    }

    finished() {
      if (this.current > 0) return;
      clearInterval(this.timer_loop);
      this.timer_loop = null;
      this.state = "Stopped";
      this.display_dom.innerText = "0:00"
      document.getElementById('start-btn').disabled = false; // reneable start btn
      console.log("Timer should stop now.");
    }
  }

  function start_timer() {
    document.getElementById('start-btn').disabled = true; // grey out after one start, to be refreshed after pause or reset.

    const select_value = document.getElementById('timer-select').value;
    const custom_input = document.getElementById('custom-timer-input').value;

    // If there's an existing timer and it's paused, resume it
    if (ptimer && ptimer.state === "Paused") {
      ptimer.startTimer(); // start btn disabling in this method
      return;
    }

    // Stop any existing timer before creating a new one
    if (ptimer) {
      ptimer.stopTimer();
    }

    let seconds;

    if (select_value === "custom") {
      const custom = parseInt(custom_input || "5");
      if (isNaN(custom) || custom <= 0) {
        alert("Please enter a valid custom time in minutes.");
        return;
      }
      seconds = custom * 60;
    } else {
      seconds = parseInt(select_value) * 60;
    }

    ptimer = new Timer(seconds, timerDisplay);
    timerDisplay.innerText = convert_seconds(seconds);
    ptimer.startTimer();
}


  function pause_timer() {
    if (ptimer && ptimer.state === "Running") {
      ptimer.pauseTimer();
      document.getElementById('start-btn').disabled = false;
      ptimer.state = "Paused";
    }
  }

  function reset_timer() {
    if (ptimer) {
      ptimer.resetTimer();
      document.getElementById('start-btn').disabled = false;
      ptimer.state = "Running";
    }
  }

  // Add task button logic
  addTaskButton.addEventListener("click", function () {
    const taskName = document.querySelector('input[name="task-name"]').value.trim();
    const taskEstTime = document.querySelector('input[name="task-est-time"]').value.trim();

    if (!taskName || !taskEstTime) return;

    const li = document.createElement("li");
    li.textContent = `${taskName} | ${taskEstTime} min`;
    taskList.appendChild(li);

    // Clear fields
    document.querySelector('input[name="task-name"]').value = "";
    document.querySelector('input[name="task-est-time"]').value = "";
  });

  // Make timer functions global
  window.start_timer = start_timer;
  window.pause_timer = pause_timer;
  window.reset_timer = reset_timer;
});
  </script>
</body>
</html>
